# name: test/sql/query/topn_pushdown.test
# description: Verify ORDER BY _id LIMIT is pushed down via MongoDB aggregation pipeline
# group: [query]

require mongo

require-env MONGODB_TEST_DATABASE_AVAILABLE

statement ok
ATTACH 'host=localhost port=27017 dbname=duckdb_mongo_test' AS mongo_test (TYPE MONGO);

# ORDER BY _id LIMIT should be pushed down as an aggregation pipeline ($sort + $limit)
query II
EXPLAIN SELECT _id FROM mongo_test.users ORDER BY _id LIMIT 2;
----
physical_plan	<REGEX>:[\s\S]*MONGO_SCAN[\s\S]*scan_method[\s\S]*aggregate[\s\S]*pipeline[\s\S]*\$sort[\s\S]*\$limit[\s\S]*

# Correctness: should still return 2 rows
query I
SELECT COUNT(*) FROM (SELECT _id FROM mongo_test.users ORDER BY _id LIMIT 2);
----
2

statement ok
DETACH mongo_test;

