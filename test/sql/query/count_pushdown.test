# name: test/sql/query/count_pushdown.test
# description: Verify COUNT(*) and COUNT(col) are pushed down via MongoDB aggregation pipeline
# group: [query]

require mongo

require-env MONGODB_TEST_DATABASE_AVAILABLE

statement ok
ATTACH 'host=localhost port=27017 dbname=duckdb_mongo_test' AS mongo_test (TYPE MONGO);

# ============================================================================
# COUNT(*) with filter - pushed down as $match + $count
# ============================================================================

# COUNT(*) with filter should be pushed down as an aggregation pipeline ($count)
query II
EXPLAIN SELECT COUNT(*) FROM mongo_test.users WHERE active = true;
----
physical_plan	<REGEX>:[\s\S]*MONGO_SCAN[\s\S]*scan_method[\s\S]*aggregate[\s\S]*pipeline[\s\S]*\$count[\s\S]*

query I
SELECT COUNT(*) FROM mongo_test.users WHERE active = true;
----
3

# ============================================================================
# COUNT(*) without filter - pushed down as $count only
# ============================================================================

# Ungrouped COUNT(*) without filter should also be pushed down
query II
EXPLAIN SELECT COUNT(*) FROM mongo_test.users;
----
physical_plan	<REGEX>:[\s\S]*MONGO_SCAN[\s\S]*scan_method[\s\S]*aggregate[\s\S]*pipeline[\s\S]*\$count[\s\S]*

query I
SELECT COUNT(*) FROM mongo_test.users;
----
4

# ============================================================================
# COUNT(col) - count non-null values, pushed down as $group with $sum/$cond
# ============================================================================

# COUNT(col) counts non-null values and should be pushed down
# All users have 'name' field, so COUNT(name) = 4
query II
EXPLAIN SELECT COUNT(name) FROM mongo_test.users;
----
physical_plan	<REGEX>:[\s\S]*MONGO_SCAN[\s\S]*scan_method[\s\S]*aggregate[\s\S]*pipeline[\s\S]*\$group[\s\S]*

query I
SELECT COUNT(name) FROM mongo_test.users;
----
4

# ============================================================================
# COUNT(*) on products collection
# ============================================================================

query I
SELECT COUNT(*) FROM mongo_test.products;
----
3

query I
SELECT COUNT(*) FROM mongo_test.products WHERE in_stock = true;
----
2

statement ok
DETACH mongo_test;

