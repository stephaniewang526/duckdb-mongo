# name: test/sql/secrets/secrets_validation.test
# description: MongoDB secret validation and error handling tests
# group: [secrets]

# Require statement will ensure this test is run with this extension loaded
require mongo

# Test creating secret with username alias
statement ok
CREATE SECRET mongo_user_alias (
    TYPE mongo,
    HOST 'localhost',
    USERNAME 'testuser',
    PASSWORD 'testpass'
);

# Test creating secret with dbname alias
statement ok
CREATE SECRET mongo_dbname_alias (
    TYPE mongo,
    HOST 'localhost',
    USER 'testuser',
    PASSWORD 'testpass',
    DBNAME 'mydb'
);

# Test creating secret with empty values (should work)
statement ok
CREATE SECRET mongo_minimal (
    TYPE mongo,
    HOST 'localhost'
);

# Test that invalid parameter names are rejected
statement error
CREATE SECRET mongo_invalid (
    TYPE mongo,
    HOST 'localhost',
    INVALID_PARAM 'value'
);
----
Unknown parameter 'invalid_param' for secret type 'mongo' with default provider 'config'

# Test CREATE OR REPLACE SECRET
statement ok
CREATE OR REPLACE SECRET mongo_replace (
    TYPE mongo,
    HOST 'localhost',
    USER 'user1',
    PASSWORD 'pass1'
);

query I
SELECT COUNT(*) FROM duckdb_secrets() WHERE name = 'mongo_replace';
----
1

statement ok
CREATE OR REPLACE SECRET mongo_replace (
    TYPE mongo,
    HOST 'localhost',
    USER 'user2',
    PASSWORD 'pass2'
);

query I
SELECT COUNT(*) FROM duckdb_secrets() WHERE name = 'mongo_replace';
----
1

# Test that password is properly redacted in secret_string
# Note: secret_map order may vary, so we just verify password=redacted appears
query T
SELECT CASE WHEN secret_string LIKE '%password=redacted%' THEN 'redacted' ELSE 'not_redacted' END FROM duckdb_secrets() WHERE name = 'mongo_replace';
----
redacted

# Verify secrets exist (order check)
query T
SELECT name FROM duckdb_secrets() WHERE name LIKE 'mongo_%' ORDER BY name;
----
mongo_dbname_alias
mongo_minimal
mongo_replace
mongo_user_alias

# Clean up
statement ok
DROP SECRET IF EXISTS mongo_user_alias;

statement ok
DROP SECRET IF EXISTS mongo_dbname_alias;

statement ok
DROP SECRET IF EXISTS mongo_minimal;

statement ok
DROP SECRET IF EXISTS mongo_replace;

