# name: test/sql/secrets/secrets_basic.test
# description: Basic MongoDB secret functionality tests
# group: [secrets]

# Require statement will ensure this test is run with this extension loaded
require mongo

# Test creating a MongoDB secret with basic parameters
statement ok
CREATE SECRET mongo_secret (
    TYPE mongo,
    HOST 'localhost',
    PORT '27017',
    USER 'testuser',
    PASSWORD 'testpass'
);

# Verify secret was created
query I
SELECT COUNT(*) FROM duckdb_secrets() WHERE name = 'mongo_secret';
----
1

# Test creating a MongoDB secret with SRV (Atlas) connection
statement ok
CREATE SECRET mongo_atlas_secret (
    TYPE mongo,
    HOST 'cluster.mongodb.net',
    USER 'atlasuser',
    PASSWORD 'atlaspass',
    SRV 'true'
);

# Verify secret was created
query I
SELECT COUNT(*) FROM duckdb_secrets() WHERE name = 'mongo_atlas_secret';
----
1

# Test creating a MongoDB secret with database and authsource
statement ok
CREATE SECRET mongo_db_secret (
    TYPE mongo,
    HOST 'localhost',
    PORT '27017',
    USER 'testuser',
    PASSWORD 'testpass',
    DATABASE 'mydb',
    AUTHSOURCE 'admin'
);

# Verify secret was created
query I
SELECT COUNT(*) FROM duckdb_secrets() WHERE name = 'mongo_db_secret';
----
1

# Test that password is redacted in secret_string
# Note: secret_map order may vary, so we just verify password=redacted appears
query T
SELECT CASE WHEN secret_string LIKE '%password=redacted%' THEN 'redacted' ELSE 'not_redacted' END FROM duckdb_secrets() WHERE name = 'mongo_secret';
----
redacted

# Test DROP SECRET
statement ok
DROP SECRET mongo_secret;

# Verify secret was dropped
query I
SELECT COUNT(*) FROM duckdb_secrets() WHERE name = 'mongo_secret';
----
0

# Test creating a MongoDB secret with TLS parameters
statement ok
CREATE SECRET mongo_tls_secret (
    TYPE mongo,
    HOST 'localhost',
    PORT '27017',
    USER 'testuser',
    PASSWORD 'testpass',
    TLS 'true'
);

# Verify secret was created
query I
SELECT COUNT(*) FROM duckdb_secrets() WHERE name = 'mongo_tls_secret';
----
1

# Test creating a MongoDB secret with TLS CA file
statement ok
CREATE SECRET mongo_docdb_secret (
    TYPE mongo,
    HOST 'docdb-cluster.xxxxx.docdb.amazonaws.com',
    PORT '27017',
    USER 'myuser',
    PASSWORD 'mypass',
    TLS 'true',
    TLS_CA_FILE '/path/to/global_bundle.pem'
);

# Verify secret was created
query I
SELECT COUNT(*) FROM duckdb_secrets() WHERE name = 'mongo_docdb_secret';
----
1

# Test attaching using secret with TLS parameters
statement ok
ATTACH '' AS mongo_tls_attach (TYPE mongo, SECRET 'mongo_tls_secret');

statement ok
DETACH mongo_tls_attach;

# Clean up remaining secrets
statement ok
DROP SECRET IF EXISTS mongo_atlas_secret;

statement ok
DROP SECRET IF EXISTS mongo_db_secret;

statement ok
DROP SECRET IF EXISTS mongo_tls_secret;

statement ok
DROP SECRET IF EXISTS mongo_docdb_secret;

