# name: test/sql/secrets/secrets_with_attach.test
# description: MongoDB ATTACH with secrets tests
# group: [secrets]

# Require statement will ensure this test is run with this extension loaded
require mongo

# Test creating a MongoDB secret
statement ok
CREATE SECRET mongo_attach_secret (
    TYPE mongo,
    HOST 'localhost',
    PORT '27017',
    USER 'testuser',
    PASSWORD 'testpass'
);

# Test ATTACH with secret
statement ok
ATTACH '' AS mongo_db (TYPE mongo, SECRET 'mongo_attach_secret');

# Verify database was attached
query I
SELECT COUNT(*) FROM duckdb_databases() WHERE database_name = 'mongo_db';
----
1

# Test DETACH
statement ok
DETACH mongo_db;

# Verify database was detached
query I
SELECT COUNT(*) FROM duckdb_databases() WHERE database_name = 'mongo_db';
----
0

# Test ATTACH with secret that includes database
statement ok
CREATE SECRET mongo_db_secret (
    TYPE mongo,
    HOST 'localhost',
    PORT '27017',
    USER 'testuser',
    PASSWORD 'testpass',
    DATABASE 'testdb'
);

statement ok
ATTACH '' AS mongo_db2 (TYPE mongo, SECRET 'mongo_db_secret');

query I
SELECT COUNT(*) FROM duckdb_databases() WHERE database_name = 'mongo_db2';
----
1

statement ok
DETACH mongo_db2;

# Test ATTACH with non-existent secret (should fail)
statement error
ATTACH '' AS mongo_db3 (TYPE mongo, SECRET 'nonexistent_secret');
----
Secret with name "nonexistent_secret" not found

# Test ATTACH without secret (should work with connection string)
statement ok
ATTACH 'host=localhost port=27017' AS mongo_db4 (TYPE mongo);

query I
SELECT COUNT(*) FROM duckdb_databases() WHERE database_name = 'mongo_db4';
----
1

statement ok
DETACH mongo_db4;

# Test default secret (unnamed secret becomes __default_mongo)
statement ok
CREATE SECRET (
    TYPE mongo,
    HOST 'localhost',
    PORT '27017',
    USER 'testuser',
    PASSWORD 'testpass'
);

# ATTACH without SECRET option should use default secret
statement ok
ATTACH '' AS mongo_db_default (TYPE mongo);

query I
SELECT COUNT(*) FROM duckdb_databases() WHERE database_name = 'mongo_db_default';
----
1

statement ok
DETACH mongo_db_default;

# Verify default secret exists (it should be named __default_mongo)
query I
SELECT COUNT(*) FROM duckdb_secrets() WHERE name = '__default_mongo';
----
1

# Clean up secrets
statement ok
DROP SECRET IF EXISTS mongo_attach_secret;

statement ok
DROP SECRET IF EXISTS mongo_db_secret;

statement ok
DROP SECRET IF EXISTS __default_mongo;

